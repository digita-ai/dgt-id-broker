= Getting started with Keycloak
:toc:
:toclevels: 1
:imagesdir: ../images


== Configuring & starting the proxy

. If you haven't already, clone the link:https://github.com/digita-ai/dgt-id-broker.git[*dgt-id-broker*] repository.
. Open your terminal in the root folder of the project and enter the following commands: 
.. `npm run bootstrap` to install all the dependencies. 
.. `npm run build:all` to build the all packages in this workspace.

.. `npm run start --scope @digita-ai/dgt-id-proxy -- --  -c ../config/presets/keycloak-config.json` to start the proxy. 
This command will start all required packages in parallel. 
Note that this server runs with LTS versions of Node.js from v12 onward. 

If you would like to start the proxy with different environment variables, such as a different URI or port you will have to start it manually. 

The following variables are available for you to change:

* `-c` to specify the path to the configuration file (e.g. *_../config/presets/keycloak-config.json_*).
* `-u` to specify the URI for the proxy (default: *_http://localhost:3003_*).
* `-U` to specify the URI of the upstream server (default: *_http://localhost:3000_*).
* `-m` to specify the main module path (default: *_../_*). 
* `-o` to specify the open id configuration file (default: *_assets/openid-configuration.json_*).
* `-j` to specify the path to the JWKS file (default: *_assets/jwks.json_*).

For example if you would like to start the proxy on a different port, open your terminal in the *dgt-id-proxy* folder and run the following command: 

* `npm run start -- -u <SCHEME:URI:PORT>` (e.g. http://localhost:3004). With the `-u` flag you can overwrite the default proxy URI which is set default to http://localhost:3003. 

Note that you will have to start the other required packages manually as well:

* Open a terminal in the *demo/demo-pods* folder and run the following command: `npm run start` to start demo pods.

* Open a terminal in the *demo/demo-client* folder and run the following command: `npm run demo:keycloak` to start the demo client.


== Launching a Keycloak server

If you haven't got an instance of Keycloak already you can start one through a Docker container as mentioned below.
(Prerequisite: Docker has to be installed on your system. If not you can download it link:https://www.docker.com/products/docker-desktop[here].)

First we will pull our Docker image and run the container. 

. Open your terminal and copy the following command replacing all the environment variables with your own:

+
[source,bash]
----
docker run -p <EPORT>:<IPORT> --name <NAME> -e KEYCLOAK_USER=<USER> -e KEYCLOAK_PASSWORD=<PWD> <IMAGE>
----
+

e.g. : `docker run -p 8080:8080 --name keycloak -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin quay.io/keycloak/keycloak:latest`

Lets's break this down a little bit: 

- The `IMAGE` for Keycloak is `quay.io/keycloak/keycloak:latest`, except for Apple devices on the M1 architecture, which work with `wizzn/keycloak:14`.

- The `IPORT` of the default Keycloak images is `8080`. Map this to the desired port on you host with `EPORT`, e.g. `8080:8080`.

- `USER` and `PWD` set the username and password for the initial admin account. (Alternatively, you can create an admin account on the Keycloak welcome page.)

- If desired, you can give the container a `NAME`.

. Open your browser and go to your hostname followed by the port you specified, e.g. `http://localhost:8080`. You  should be redirected to the Keycloak welcome page. Click *Adminstration Console* to log in as the admin user you have created through the Docker command.

+
[#img-keycloak-admin-login]
image::keycloak-admin-login.png[Keycloak Admin Login]
+


== Configuring a realm

If you haven't already, you can create a realm in Keycloak as described below. (By default, there is already a Master realm, but it is advised to create another one for each purpose.)

. When in the Keycloak admin console, click on the dropdown menu on the top left, labeled with the name of the current realm (`Master` on a fresh image), and choose *Add realm*.

. Enter a name for the realm.

. If desired, you can import a JSON file here containing a preexisting realm configuration. 

. Set the enabled flag to `On`.

. Click *Create* to create the Realm.

+
[#img-keycloak-add-realm]
image::add-demo-realm.png[Keycloak Add Realm]
+

Next you'll be able to set your realm settings. Make sure you have selected the realm you just created.


== Creating a client

In order to let the proxy access the upstream provider's data we need to add it as a static client.

. In the left menu of the admin console, click *Clients*. You will see a list of all clients. 

. On the far right click *Create* to create a new client. Note that you again have the option to upload a JSON file containing the client configuration instead.

. Fill in a *Client ID* (e.g. `http://username.pods.digita.ai/profile/card#me`), which will be used in URIs and tokens.

. For *Client Protocol* select `openid-connect`, since Solid is based on the OpenID Connect standard.

. For *Access Type* select `confidential` so that clients require a secret to initiate the login protocol.

. Specify a *Root URL* (e.g. `http://localhost:8080/myrealm`) that will be used as a prefix for relative URLs.

. Click *Save* to create the client.

+
[#img-keycloak-add-client]
image::add-client.png[Keycloak Add Client]
+

. You will be directed to the client settings page. There are some important settings in the *Settings* tab that you need to check here.

. Make sure *Implicit Flow Enabled* is set to `OFF`` in order for your client to remain Solid-compliant. 

. Add the proxy's redirect URI to the list of *Valid Redirect URIs*. The proxy's redirect URI is set in the `dgt-id-proxy/config/presets/keycloak-config.json` file under the *_redirectUri_* predicates for `ClientIdStaticTokenHandler` and `ClientIdStaticAuthRequestHandler`. Make sure these match. If you started the proxy using a custom URI make sure to change the redirect URI's accordingly.

. Switch to the *Credentials* tab and set the *Client Authenticator* to `Client ID and Secret`.


== Creating a user

If you'd like to add preset users to the realm you can do so as described below.

. In the menu to the left, click *Users* and then *Add user*.

. Enter a username. The rest of the fields are not required but recommended.

. Click *Save*. The interface will immediately show you the new user's settings.

. Click the *Credentials* tab to set a temporary user password and confirm it by pressing *Set Password*. The user will be required to change it on the first login, unless you set the *Temporary* flag to `OFF`.

[#img-keycloak-add-user]
image::add-user.png[Keycloak Add User]

[#img-keycloak-user-credentials]
image::user-credentials.png[Keycloak User Credentials]