= Getting started with Keycloak
:toc:
:toclevels: 1
:imagesdir: ../images

== Configuring & starting the proxy

. If you haven't already, clone the link:https://github.com/digita-ai/dgt-id-broker.git[*dgt-id-broker*] repository.
. Open your terminal in the root folder of the project and enter the following commands: 
.. *_npm run bootstrap_* to install all the dependencies.
.. *_npm run build:all_* to build the all packages in this workspace.
.. *_npm run start_* to start the proxy.

== Launching a Keycloak server

If you haven't got an instance of Keycloak already you can start one through a Docker container as mentioned below.
Prerequisites: Docker is already installed on your system. If not you can download it link:https://www.docker.com/products/docker-desktop[here].

First we will pull our Docker image and run the container. 

. Open your terminal and run the following command: 

+
--
*_docker run -p <PORT>:<PORT> --name <CONTAINER-NAME> -e KEYCLOAK_USER=<USER> -e KEYCLOAK_PASSWORD=<PASSWORD> <IMAGE_NAME>_*
--
+

Lets's break this down a little bit: 

.. Docker will run on the internal and external port specified by the *-p* argument, e.g. *8080:8080*.
.. We will name our Docker container with the *--name* argument, e.g. *keycloak-demo*.
.. We will set the *KEYCLOAK_USER* and *KEYCLOAK_PASSWORD* environment variables to create an admin account from the command line using the *-e* flag. Note that you can also remove these optional arguments and create an admin account on the Keycloak welcome page instead, you can find more info on that link:https://wjw465150.gitbooks.io/keycloak-documentation/content/getting_started/topics/first-boot/initial-user.html[here].
.. We will pull a Keycloak Docker image, e.g. *quay.io/keycloak/keycloak:latest*.

. Open your browser and go to your hostname followed by the port you specified, e.g. *http://localhost:8080*. If you are redirected to the Keycloak welcome page you've successfully launched the Keycloak server. Click *_Adminstration Console_* to login as the admin user we have just created through the Docker command.

+
[#img-keycloak-admin-login]
image::keycloak-admin-login.png[Keycloak Admin Login]
+


== Configering a realm

If you haven't already, you can create a realm in Keycloak as described below.

. When in the Keycloak admin console in the Master menu on the top left, click *_Add realm_*.
. Enter a name for the realm, e.g. "demo".

+
[#img-keycloak-add-realm]
image::add-demo-realm.png[Keycloak Add Realm]
+

. You can import a JSON file here containing the realm configuration, this can contain settings like clients, users and roles. However if you choose not to upload this file you are able to set all these configurations after the following steps.
. Set the enabled flag to *True*.
. Click *_Create_* to create the Realm.

Next you'll be able to set your realm settings, make sure you have selected the realm you just created.

== Creating a client

In order to let the proxy access the upstream provider's data we need to add it as a static client.

. In the left menu of the admin console, click *_Clients_*.
. You will see a list of all clients. On the far right click *_Create_* to create a new client. Note that you again have the option to upload a JSON file containing the client configuration instead.
. Fill in the *_Client ID_* , e.g. "id-proxy". This specifies the ID that will be used in URI's and tokens.
. In *_Client Protocol_* select *_openid-connect_* since *SOLID* is based on the *OIDC Protocol*.
. In *_Access Type_* select *_confidential_* so that clients require a secret to initiate the login protocol.
. Specify a root URL that will be appended to relative URL's, e.g. *_http://localhost:8080/id-proxy_*.
. Click *_Save_* to create the client.

+
[#img-keycloak-add-client]
image::add-client.png[Keycloak Add Client]
+

. You will be directed to the client settings page. There are some important settings in the *_Settings_* tab that you need to check here.
. Make sure *_Implicit Flow Enabled_* is set to *_OFF_* in order for your client to remain *SOLID* compliant. It is not allowed to use the implicit flow due to the inherent risks of returning access tokens in an HTTP redirect without any confirmation that it has been received by the client.
. Under *_Web Origins_* you *MUST* set the proxy host URL in the allowed *CORS* origins, e.g. *_http://localhost:80808_* in order to prevent *CORS* errors. 
. Make sure to add the required *_Valid Redirect URIs* path, e.g. *_/realm/<REALM_NAME>/account/*_*, since this is crucial for the proxy to work. A redirect uri is required in *OIDC* because this will tell provider where the response needs to be sent after logging in. 

. Switch to the *_Credentials_* tab and set the *_Client Authenticator_* to Client ID and Secret.

== Creating a user

If you'd like to add users to the realm you can do so as described below.

. In the menu to the left, click *_Users_* and then *_Add user_*.
. Enter a username, e.g. *"johndoe"*. The rest of the fields are not required but recommended.

[#img-keycloak-add-user]
image::add-user.png[Keycloak Add User]

[start=3]
. Click *_Create_* to create the user.
. Make sure you switch *_Email verified_* to *_ON_*.
. Click *_Save_* and the management console will show you the new user.
. Click the *_Credentials_* tab to set a temporary user password and confirm it by pressing *_Set Password_*.

+
[#img-keycloak-user-credentials]
image::user-credentials.png[Keycloak User Credentials]
+

[NOTE]
====
This password is temporary and the user will be required to change it on the first login.
If you wish to create a permanent password set the *_Temporary_* flag to *_OFF_*.
====