= Getting started with Keycloak
:toc:
:toclevels: 1
:imagesdir: ../images

== Configuring & starting the proxy

. If you haven't already, clone the link:https://github.com/digita-ai/dgt-id-broker.git[*dgt-id-broker*] repository.
. Open your terminal in the root folder of the project and enter the following commands: 
.. *_npm run bootstrap_* to install all the dependencies.
.. *_npm run build:all_* to build the all packages in this workspace.
.. *_npm run start_* to start the proxy.

== Launching a Keycloak server

If you haven't got an instance of Keycloak already you can start one through a Docker container as mentioned below.
Prerequisites: Docker is already installed on your system. If not you can download it link:https://www.docker.com/products/docker-desktop[here].

First we will pull our Docker image and run the container. 

. Open your terminal and run the following command: 

+
--
*_docker run -p <PORT>:<PORT> --name <CONTAINER-NAME> -e KEYCLOAK_USER=<USER> -e KEYCLOAK_PASSWORD=<PASSWORD> <IMAGE_NAME>_*
--
+

Lets's break this down a little bit: 

.. Docker will run on the internal and external port specified by the *-p* argument, e.g. *8080:8080*.
.. We will name our Docker container with the *--name* argument, e.g. *keycloak-demo*.
.. We will set the *KEYCLOAK_USER* and *KEYCLOAK_PASSWORD* environment variables to create an admin account from the command line using the *-e* flag. Note that you can also remove these optional arguments and create an admin account on the Keycloak welcome page instead, you can find more info on that link:https://wjw465150.gitbooks.io/keycloak-documentation/content/getting_started/topics/first-boot/initial-user.html[here].
.. We will pull a Keycloak Docker image, e.g. *quay.io/keycloak/keycloak:latest*.

. Open your browser and go to your hostname followed by the port you specified, e.g. *http://localhost:8080*. If you are redirected to the Keycloak welcome page you've successfully launched the Keycloak server. Click *_Adminstration Console_* to login as the admin user we have just created through the Docker command.

+
[#img-keycloak-admin-login]
image::keycloak-admin-login.png[Keycloak Admin Login]
+


== Creating a realm

If you haven't already, you can create a realm in Keycloak as described below.

. When in the Keycloak admin console in the Master menu on the top left, click *_Add realm_*.
. Enter a name for the realm, e.g. "demo".

+
[#img-keycloak-add-realm]
image::add-demo-realm.png[Keycloak Add Realm]
+

. You can import a JSON file here containing the realm configuration, this can contain settings like clients, users and roles. However if you choose not to upload this file you are able to set all these configurations after the following steps.
. Set the enabled flag to *True*.
. Click *_Create_* to create the Realm.

Next you'll be able to set your realm settings, make sure you have selected the realm you just created.

== Creating a user

. In the menu to the left, click *_Users_* and then *_Add user_*.
. Enter a username, e.g. "johndoe". The rest of the fields are not required but recommended.

[#img-keycloak-add-user]
image::add-user.png[Keycloak Add User]

[start=3]
. Click *_Create_* to create the user.
. Make sure you switch *_Email verified_* to *_ON_*.
. Click *_Save_* and the management console will show you the new user.
. Click the *_Credentials_* tab to set a temporary user password and confirm it by pressing *_Set Password_*.

+
[#img-keycloak-user-credentials]
image::user-credentials.png[Keycloak User Credentials]
+

[NOTE]
====
This password is temporary and the user will be required to change it on the first login.
If you wish to create a permanent password set the *_Temporary_* flag to *_OFF_*.
====

== Creating a client

. In the left menu of the admin console, click *_Clients_*.
. You will see a list of all clients. On the far right click *_Create_* to create a new client. Note that you again have to option to upload a JSON file containing the client configuration instead.
. Fill in the *_Client ID_* , e.g. "demo-client". This specifies the ID that will be used in URI's and tokens.
. In *_Client Protocol_* select *_openid-connect_*.
. You can also specify a root URL that will be appended to relative URL's.
. Click *_Save_* to create the client.

+
[#img-keycloak-add-client]
image::add-client.png[Keycloak Add Client]
+

. You will be directed to the client settings page. There are some important settings that you need to check here.
. Make sure *_Implicit Flow Enabled_* is set to *_OFF_* in order for your client to remain *SOLID* compliant.
. Under *_Web Origins_* you can set the allowed *CORS* origins
. Click the *_Scope_* tab and make sure *_Full Scope Allowed_* is set to *_OFF_* and add *_admin_* & *_user_* to Realm's available roles.

== Logging in to the account console

The user you've just created now has access to the account console. This console can be used to manage the user's account,
update your profile information or change your login credentials.

. Log out of the admin console by clicking *_Sign Out_*.
. Go to http://localhost:8080/auth/realms/demo/account and log in to the Demo realm with the user credentials you've just created.
. If you set the temporary password flag to *_ON_* earlier, you will be required to change the password upon logging in.
. The account console will show you the user's profile information. You can now edit the account.
. Make sure you enter the required information and click *_Save_*.

